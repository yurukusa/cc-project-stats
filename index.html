<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CC Project Stats — Where is your AI time actually going?</title>
<meta name="description" content="See which projects your Claude Code sessions are spending time on. You vs AI hours per project. Select your ~/.claude folder. No install, no data sent anywhere.">
<meta property="og:title" content="CC Project Stats — Where is your AI time actually going?">
<meta property="og:description" content="Per-project breakdown of Claude Code hours: you vs AI autonomy. Free, local, zero-dependency.">
<style>
  *{box-sizing:border-box;margin:0;padding:0}
  body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;background:#0d1117;color:#e6edf3;min-height:100vh;display:flex;flex-direction:column;align-items:center;padding:24px 16px}
  .header{text-align:center;margin-bottom:32px}
  .header h1{font-size:1.6rem;font-weight:700;color:#e6edf3;margin-bottom:6px}
  .header p{color:#8b949e;font-size:0.9rem}
  .pick-box{background:#161b22;border:1px solid #30363d;border-radius:12px;padding:28px;text-align:center;max-width:700px;width:100%;margin-bottom:20px}
  .pick-controls{display:flex;gap:12px;align-items:center;justify-content:center;flex-wrap:wrap;margin-bottom:12px}
  .pick-label{color:#8b949e;font-size:0.85rem}
  .btn-pick{display:inline-block;background:#21262d;border:1px solid #388bfd;color:#79c0ff;padding:12px 24px;border-radius:8px;font-size:0.95rem;cursor:pointer;transition:background 0.2s;font-weight:500}
  .btn-pick:hover{background:#2d333b}
  select{background:#21262d;border:1px solid #30363d;color:#e6edf3;padding:10px 14px;border-radius:8px;font-size:0.88rem;cursor:pointer}
  .status{margin-top:12px;font-size:0.82rem;color:#8b949e;min-height:20px}
  .status.ok{color:#3fb950}
  .status.err{color:#f85149}
  /* results */
  .results{max-width:700px;width:100%;display:none}
  .results.visible{display:block}
  .summary-row{display:flex;gap:16px;margin-bottom:20px;flex-wrap:wrap}
  .sum-box{background:#161b22;border:1px solid #30363d;border-radius:8px;padding:14px 18px;flex:1;min-width:130px}
  .sum-box .n{font-size:1.4rem;font-weight:700}
  .sum-box .l{font-size:0.75rem;color:#8b949e;margin-top:2px}
  /* project table */
  .proj-table{background:#161b22;border:1px solid #30363d;border-radius:12px;overflow:hidden;margin-bottom:16px}
  .proj-header{display:grid;grid-template-columns:1fr 80px 80px 80px 55px;gap:8px;padding:10px 16px;font-size:0.75rem;color:#8b949e;border-bottom:1px solid #30363d;font-weight:600;letter-spacing:0.3px}
  .proj-row{padding:12px 16px;border-bottom:1px solid #21262d;display:grid;grid-template-columns:1fr 80px 80px 80px 55px;gap:8px;align-items:center}
  .proj-row:last-child{border-bottom:none}
  .proj-name{font-size:0.88rem;font-weight:600;color:#e6edf3;min-width:0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .proj-name.top{color:#79c0ff}
  .proj-hours{font-size:0.85rem;text-align:right}
  .proj-pct{font-size:0.78rem;color:#8b949e;text-align:right}
  .ai-pct{font-size:0.78rem;text-align:right;font-weight:600}
  .ai-high{color:#3fb950}
  .ai-mid{color:#e3b341}
  .ai-low{color:#79c0ff}
  /* bar vis */
  .bar-row{display:flex;gap:2px;height:6px;border-radius:4px;overflow:hidden;margin-top:4px;width:100%}
  .bar-you{background:#79c0ff;height:100%}
  .bar-ai{background:#3fb950;height:100%}
  .bar-rest{background:#21262d;height:100%;flex:1}
  /* legend */
  .legend{display:flex;gap:16px;font-size:0.75rem;color:#8b949e;margin-bottom:16px}
  .legend-item{display:flex;align-items:center;gap:6px}
  .legend-dot{width:10px;height:10px;border-radius:2px}
  /* share */
  .share-section{background:#161b22;border:1px solid #30363d;border-radius:12px;padding:20px;margin-bottom:16px}
  .share-title{font-size:0.8rem;color:#8b949e;margin-bottom:12px}
  .btn-share{background:#238636;color:#fff;border:none;padding:10px 20px;border-radius:8px;cursor:pointer;font-size:0.88rem;font-weight:600;margin-right:8px;transition:background 0.2s}
  .btn-share:hover{background:#2ea043}
  .btn-copy{background:#21262d;border:1px solid #30363d;color:#e6edf3;padding:10px 16px;border-radius:8px;cursor:pointer;font-size:0.88rem;transition:background 0.2s}
  .btn-copy:hover{background:#2d333b}
  .copy-ok{display:none;font-size:0.8rem;color:#3fb950;margin-top:8px}
  .copy-ok.show{display:block}
  /* footer */
  .footer{margin-top:24px;font-size:0.78rem;color:#4b5563;text-align:center;max-width:700px}
  .footer a{color:#6b7280;text-decoration:none}
  .footer a:hover{color:#8b949e}
  input[type=file]{display:none}
</style>
</head>
<body>

<div class="header">
  <h1>CC Project Stats</h1>
  <p>Where is your Claude Code time actually going?</p>
</div>

<div class="pick-box" id="pickBox">
  <div class="pick-label" style="margin-bottom:12px">Select your <code>~/.claude</code> folder to see per-project stats</div>
  <div class="pick-controls">
    <label class="btn-pick" for="folderInput">Browse My Claude Folder</label>
    <select id="periodSelect">
      <option value="7">Last 7 days</option>
      <option value="14">Last 14 days</option>
      <option value="30">Last 30 days</option>
      <option value="0">All time</option>
    </select>
  </div>
  <input type="file" id="folderInput" webkitdirectory multiple accept="">
  <div class="status" id="status">No data loaded yet</div>
</div>

<div class="results" id="results">
  <div class="summary-row" id="summaryRow"></div>

  <div class="legend">
    <div class="legend-item"><div class="legend-dot" style="background:#79c0ff"></div> Your hours (interactive)</div>
    <div class="legend-item"><div class="legend-dot" style="background:#3fb950"></div> AI hours (autonomous)</div>
  </div>

  <div class="proj-table">
    <div class="proj-header">
      <div>Project</div>
      <div style="text-align:right">You</div>
      <div style="text-align:right">AI</div>
      <div style="text-align:right">Total</div>
      <div style="text-align:right">AI%</div>
    </div>
    <div id="projRows"></div>
  </div>

  <div class="share-section">
    <div class="share-title">Share your top project</div>
    <button class="btn-share" id="btnShare">Share on Twitter</button>
    <button class="btn-copy" id="btnCopy">Copy text</button>
    <div class="copy-ok" id="copyOk">Copied!</div>
  </div>
</div>

<div class="footer">
  <a href="https://yurukusa.github.io/cc-toolkit/">← All 27 cc-toolkit tools</a> ·
  <a href="https://github.com/yurukusa/cc-project-stats">GitHub</a> ·
  No data leaves your machine
</div>

<script>
// ── File reading ──────────────────────────────────────────────────────────────
async function _readFirstLast(file) {
  const CHUNK = 4096;
  const size = file.size;
  if (size === 0) return { first: '', last: '' };
  const dec = new TextDecoder('utf-8', { fatal: false });

  const headBuf = await file.slice(0, Math.min(CHUNK, size)).arrayBuffer();
  const headText = dec.decode(new Uint8Array(headBuf));
  const firstNl = headText.indexOf('\n');
  const first = firstNl >= 0 ? headText.slice(0, firstNl) : headText;

  const tailBuf = await file.slice(Math.max(0, size - CHUNK)).arrayBuffer();
  const tailText = dec.decode(new Uint8Array(tailBuf));
  const lines = tailText.split('\n').filter(l => l.trim());
  const last = lines.length > 0 ? lines[lines.length - 1] : first;

  return { first, last };
}

function parseTs(line) {
  try { const o = JSON.parse(line); return o.timestamp ? new Date(o.timestamp) : null; } catch { return null; }
}

function toLocalDate(d) {
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
}

function cleanProjectName(dirName) {
  if (dirName.startsWith('-tmp')) return '/tmp';
  const parts = dirName.split('-').filter(Boolean);
  if (parts[0] === 'home' && parts.length >= 2) {
    const rest = parts.slice(2);
    if (rest.length === 0) return '~';
    if (rest[0] === 'projects') rest.shift();
    return rest.join('-') || '~';
  }
  return dirName;
}

// ── Main processor ────────────────────────────────────────────────────────────
async function processDir(fileList, days) {
  // path: <rootfolder>/.claude/projects/<dir>/<file>.jsonl
  //       <rootfolder>/.claude/projects/<dir>/subagents/<file>.jsonl
  const bucket = {}; // projectName → { main: hours, sub: hours, sessions: n }

  const cutoffDate = days > 0
    ? (() => { const d = new Date(); d.setDate(d.getDate() - days); return toLocalDate(d); })()
    : null;

  const jsonlFiles = Array.from(fileList).filter(f => {
    const p = f.webkitRelativePath || f.name;
    return p.endsWith('.jsonl') && p.includes('/projects/');
  });

  if (jsonlFiles.length === 0) return null;

  for (const file of jsonlFiles) {
    const p = file.webkitRelativePath || file.name;
    // Extract project dir name from path
    // pattern: .../.claude/projects/<projectDir>/.../*.jsonl
    const match = p.match(/\/projects\/([^/]+)\//);
    if (!match) continue;
    const rawDir = match[1];
    const projName = cleanProjectName(rawDir);

    // Is this a subagent session?
    const isSub = p.includes('/subagents/');

    const { first, last } = await _readFirstLast(file);
    const t1 = parseTs(first);
    const t2 = parseTs(last);
    if (!t1 || !t2) continue;

    // Date filter
    if (cutoffDate) {
      const fileDate = toLocalDate(t1);
      if (fileDate < cutoffDate) continue;
    }

    const hours = Math.max(0, (t2 - t1) / 3600000);

    if (!bucket[projName]) bucket[projName] = { main: 0, sub: 0, sessions: 0 };
    if (isSub) bucket[projName].sub += hours;
    else { bucket[projName].main += hours; bucket[projName].sessions++; }
  }

  return bucket;
}

// ── Render ────────────────────────────────────────────────────────────────────
let _lastBucket = null;
let _lastLabel = '';

function renderResults(bucket, label) {
  _lastBucket = bucket;
  _lastLabel = label;

  const entries = Object.entries(bucket)
    .map(([name, v]) => ({ name, main: v.main, sub: v.sub, total: v.main + v.sub, sessions: v.sessions }))
    .filter(e => e.total > 0.01)
    .sort((a, b) => b.total - a.total);

  if (entries.length === 0) {
    document.getElementById('status').textContent = 'No activity in selected period.';
    document.getElementById('status').className = 'status err';
    return;
  }

  const totalHours = entries.reduce((s, e) => s + e.total, 0);
  const totalMain = entries.reduce((s, e) => s + e.main, 0);
  const totalSub = entries.reduce((s, e) => s + e.sub, 0);
  const topProject = entries[0];

  // Summary boxes
  const sr = document.getElementById('summaryRow');
  sr.innerHTML = `
    <div class="sum-box"><div class="n">${fmtH(totalHours)}</div><div class="l">Total hours</div></div>
    <div class="sum-box"><div class="n">${fmtH(totalMain)}</div><div class="l">Your hours</div></div>
    <div class="sum-box"><div class="n">${fmtH(totalSub)}</div><div class="l">AI hours</div></div>
    <div class="sum-box"><div class="n">${entries.length}</div><div class="l">Projects</div></div>
  `;

  // Project rows
  const pr = document.getElementById('projRows');
  pr.innerHTML = entries.slice(0, 15).map((e, i) => {
    const aiPct = e.total > 0 ? Math.round(e.sub / e.total * 100) : 0;
    const shareOfTotal = totalHours > 0 ? e.total / totalHours : 0;
    const shareOfTotalStr = shareOfTotal > 0.005 ? Math.round(shareOfTotal * 100) + '%' : '<1%';
    const aiClass = aiPct >= 70 ? 'ai-high' : aiPct >= 40 ? 'ai-mid' : 'ai-low';
    const nameClass = i === 0 ? 'proj-name top' : 'proj-name';
    const mainPct = e.total > 0 ? e.main / e.total : 0;
    const subPct = e.total > 0 ? e.sub / e.total : 0;
    const fillMain = Math.round(mainPct * shareOfTotal * 100);
    const fillSub = Math.round(subPct * shareOfTotal * 100);
    const fillRest = Math.max(0, 100 - fillMain - fillSub);
    return `<div class="proj-row">
      <div>
        <div class="${nameClass}">${esc(e.name)}</div>
        <div class="bar-row"><div class="bar-you" style="width:${fillMain}%"></div><div class="bar-ai" style="width:${fillSub}%"></div><div class="bar-rest" style="width:${fillRest}%"></div></div>
      </div>
      <div class="proj-hours" style="color:#79c0ff">${fmtH(e.main)}</div>
      <div class="proj-hours" style="color:#3fb950">${fmtH(e.sub)}</div>
      <div class="proj-hours">${fmtH(e.total)}</div>
      <div class="proj-pct ${aiClass}">${aiPct}%</div>
    </div>`;
  }).join('');

  // Share
  const shareText = `My Claude Code project breakdown ${label}:\n` +
    entries.slice(0, 3).map(e => {
      const aiPct = e.total > 0 ? Math.round(e.sub / e.total * 100) : 0;
      return `  ${e.name}: ${fmtH(e.total)} (${aiPct}% AI)`;
    }).join('\n') +
    `\n\n#ClaudeCode cc-project-stats → yurukusa.github.io/cc-project-stats/`;

  document.getElementById('btnShare').onclick = () => {
    window.open(`https://x.com/intent/tweet?text=${encodeURIComponent(shareText)}`, '_blank');
  };
  document.getElementById('btnCopy').onclick = () => {
    navigator.clipboard.writeText(shareText).then(() => {
      const el = document.getElementById('copyOk');
      el.classList.add('show');
      setTimeout(() => el.classList.remove('show'), 2000);
    });
  };

  document.getElementById('results').classList.add('visible');
}

function fmtH(h) {
  if (h < 0.1) return '—';
  if (h < 1) return Math.round(h * 60) + 'm';
  return h.toFixed(1) + 'h';
}

function esc(s) {
  return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

// ── File input handler ────────────────────────────────────────────────────────
async function loadFiles(files) {
  const days = parseInt(document.getElementById('periodSelect').value);
  const label = days === 0 ? '(all time)' :
    days === 7 ? '(last 7 days)' : days === 14 ? '(last 14 days)' : '(last 30 days)';

  const st = document.getElementById('status');
  st.textContent = `Reading ${files.length} files...`;
  st.className = 'status';

  try {
    const bucket = await processDir(files, days);
    if (!bucket || Object.keys(bucket).length === 0) {
      st.textContent = 'No Claude Code session data found. Make sure you selected the .claude folder.';
      st.className = 'status err';
      return;
    }
    const projects = Object.values(bucket).filter(v => v.main + v.sub > 0.01).length;
    st.textContent = `Loaded ${projects} projects from ${files.length} files ${label}`;
    st.className = 'status ok';
    renderResults(bucket, label);
  } catch (err) {
    st.textContent = `Error: ${err.message}`;
    st.className = 'status err';
  }
}

let _lastFiles = null;
document.getElementById('folderInput').addEventListener('change', async (e) => {
  _lastFiles = e.target.files;
  if (_lastFiles && _lastFiles.length > 0) await loadFiles(_lastFiles);
});

// Re-filter when period changes without re-reading files
document.getElementById('periodSelect').addEventListener('change', async () => {
  if (_lastFiles) await loadFiles(_lastFiles);
});
</script>
</body>
</html>
